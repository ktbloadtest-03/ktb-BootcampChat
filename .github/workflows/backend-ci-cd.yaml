name: Backend CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci-cd.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci-cd.yaml'
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: ktb-chat-backend

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        working-directory: apps/backend
        run: mvn clean package -DskipTests

      - name: Run tests
        if: ${{ false }}
        working-directory: apps/backend
        run: mvn test

  build-and-push-image:
    name: Build and Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and Push Docker Image
        run: |
          # Î∏åÎûúÏπòÎ™ÖÍ≥º SHAÎ°ú ÌÉúÍ∑∏ Í≤∞Ï†ï
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            IMAGE_TAG="main-${{ github.sha }}"
            LATEST_TAG="latest"
          else
            IMAGE_TAG="develop-${{ github.sha }}"
            LATEST_TAG=""
          fi
          
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${IMAGE_TAG}"
          
          echo "Building Docker image: ${IMAGE_NAME}"
          docker build --platform linux/amd64 -t ${IMAGE_NAME} apps/backend
          
          echo "Pushing Docker image: ${IMAGE_NAME}"
          docker push ${IMAGE_NAME}
          
          # main Î∏åÎûúÏπòÏù∏ Í≤ΩÏö∞ latest ÌÉúÍ∑∏ÎèÑ Ìë∏Ïãú
          if [ -n "${LATEST_TAG}" ]; then
            LATEST_IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${LATEST_TAG}"
            docker tag ${IMAGE_NAME} ${LATEST_IMAGE}
            echo "Pushing Docker image: ${LATEST_IMAGE}"
            docker push ${LATEST_IMAGE}
          fi

  deploy:
    name: Deploy to Server
    needs: build-and-push-image
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST_BE }} >> ~/.ssh/known_hosts

      - name: Check if Docker is installed
        id: check-docker
        run: |
          DOCKER_EXISTS=$(ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST_BE }} 'command -v docker >/dev/null && echo "true" || echo "false"')
          echo "docker_exists=$DOCKER_EXISTS" >> $GITHUB_OUTPUT

      - name: Install Docker on EC2
        if: steps.check-docker.outputs.docker_exists == 'false'
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST_BE }} << 'EOF'
            sudo apt-get update
            sudo apt-get install -y \
              ca-certificates \
              curl \
              gnupg \
              lsb-release
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
              | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
              https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" \
              | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            sudo usermod -aG docker $USER
          EOF

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST_BE }} << 'EOF'
            set -e
          
            # Docker Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ Í≤∞Ï†ï
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              IMAGE_TAG="main-${{ github.sha }}"
            else
              IMAGE_TAG="develop-${{ github.sha }}"
            fi
          
            IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/ktb-chat-backend:${IMAGE_TAG}"
          
            echo "=========================================="
            echo "  Deploying: ${IMAGE_NAME}"
            echo "=========================================="
          
            # Docker Hub Î°úÍ∑∏Ïù∏
            echo "üîê Logging in to Docker Hub..."
            echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin || true
          
            # Docker Ïù¥ÎØ∏ÏßÄ pull
            echo "üì• Pulling Docker image..."
            docker pull ${IMAGE_NAME}
          
            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Î∞±ÏóÖ (Î°§Î∞±ÏùÑ ÏúÑÌï¥)
            OLD_CONTAINER=$(docker ps -a --filter "name=ktb-chat-backend" --format "{{.ID}}" | head -1)
            if [ -n "$OLD_CONTAINER" ]; then
              echo "üì¶ Backing up old container..."
              docker rename ktb-chat-backend ktb-chat-backend-backup-$(date +%s) 2>/dev/null || true
            fi
          
            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è Ï†úÍ±∞
            echo "üõë Stopping existing containers..."
            docker stop ktb-chat-backend 2>/dev/null || true
            docker rm ktb-chat-backend 2>/dev/null || true
          
            # CORS ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (ÌîÑÎ°†Ìä∏ÏóîÎìú ÎèÑÎ©îÏù∏)
            CORS_ENV=""
            if [ -n "${{ secrets.SERVER_HOST_FE }}" ]; then
              CORS_ENV="-e CORS_ALLOWED_ORIGINS=${{ secrets.SERVER_HOST_FE }}"
              echo "üåê CORS ÏÑ§Ï†ï: ${{ secrets.SERVER_HOST_FE }}"
            fi
          
            # JWT ÏãúÌÅ¨Î¶ø ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
            JWT_ENV="d7689060b5bc059a5661401c72f820614ed942d15e4aa928b633e60f1e17cef9"
          
            # ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
            echo "üöÄ Starting new container..."
            docker run -d \
              --name ktb-chat-backend \
              --restart unless-stopped \
              -p 5001:5001 \
              -p 5002:5002 \
              ${CORS_ENV} \
              -e JWT_SECRET=${JWT_ENV} \
              ${IMAGE_NAME}
          
            # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
            echo "‚è≥ Waiting for container to start..."
            sleep 5
          
            if ! docker ps | grep -q ktb-chat-backend; then
              echo "‚ùå Container failed to start"
              docker logs ktb-chat-backend 2>/dev/null || true
              exit 1
            fi
          
            # Ìó¨Ïä§Ï≤¥ÌÅ¨ (ÏµúÎåÄ 60Ï¥à ÎåÄÍ∏∞)
            echo "üè• Performing health check..."
            MAX_WAIT=60
            ELAPSED=0
            HEALTHY=false
          
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              if curl -sf http://localhost:5001/api/health > /dev/null 2>&1; then
                HEALTHY=true
                break
              fi
              sleep 2
              ELAPSED=$((ELAPSED + 2))
              echo -n "."
            done
            echo ""
          
            if [ "$HEALTHY" = true ]; then
              echo "‚úÖ Health check passed!"
          
              # Ïò§ÎûòÎêú Î∞±ÏóÖ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨ (ÏµúÍ∑º 3Í∞úÎßå Ïú†ÏßÄ)
              echo "üßπ Cleaning up old backup containers..."
              docker ps -a --filter "name=ktb-chat-backend-backup" --format "{{.ID}} {{.CreatedAt}}" | \
                sort -k2 -r | tail -n +4 | cut -d' ' -f1 | \
                xargs -r docker rm -f 2>/dev/null || true
          
              echo "=========================================="
              echo "‚úÖ Deployment completed successfully!"
              echo "=========================================="
            else
              echo "‚ùå Health check failed after ${MAX_WAIT}s"
              echo "üìã Container logs:"
              docker logs --tail 50 ktb-chat-backend
              exit 1
            fi
          EOF
